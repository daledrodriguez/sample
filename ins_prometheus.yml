- hosts: remote
  become: true
  tasks:
    - name: Create the private key
      community.crypto.openssl_privatekey:
        path: "/home/rodriguez/hoa9/tls.key"
        size: 4096

    - name: Create certificate signing request (CSR) for self-signed certificate
      community.crypto.openssl_csr_pipe:
        privatekey_path: "/home/rodriguez/hoa9/tls.key"
        common_name: docker-registry
        subject_alt_name:
          - "DNS:docker-registry"
      register: csr

    - name: Create self-signed certificate from CSR
      community.crypto.x509_certificate:
        path: "/home/rodriguez/hoa9/tls.crt"
        csr_content: "{{ csr.csr }}"
        privatekey_path: "/home/rodriguez/hoa9/tls.key"
        provider: selfsigned
        selfsigned_not_after: +365d # valid for one year
        selfsigned_not_before: "-1d" # valid since yesterday
        selfsigned_digest: "sha256" # this is the default and can be omitted
